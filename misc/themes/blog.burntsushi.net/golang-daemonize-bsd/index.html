<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Daemonizing Go Programs (with a BSD-style rc.d example) - Andrew Gallant&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <meta name="description" content="I blog mostly about my own programming projects.">
  
  <meta name="author" content="">
  <meta name="keywords" content="">
  <link rel="canonical" href="index.html">

  
  <link rel="stylesheet" type="text/css" href="../css/basscss.css">
  <link rel="stylesheet" type="text/css" href="../css/main.css">
  <link rel="stylesheet" type="text/css" href="../css/chroma-fruity-light.css">
  <link rel="stylesheet" type="text/css" href="../css/override.css">
</head>
<body class="">

<div class="site-wrap">
  <header class="site-header px2 px-responsive">
  <div class="mt2 wrap">
    <div class="measure">
      <a href="../index.html" class="site-title">Andrew Gallant&#39;s Blog</a>
      <nav class="site-nav right">
      <a href="../about/index.html">About</a>
<a href="../projects/index.html">Projects</a>
<a href="https://github.com/BurntSushi">GitHub</a>


      </nav>
      <div class="clearfix"></div>
    </div>
  </div>
</header>

  <div class="post p2 p-responsive wrap" role="main">
    <div class="measure">
      <div class="post-header mb2">
        <h1>Daemonizing Go Programs (with a BSD-style rc.d example)</h1>
        <span class="post-meta">Apr 27, 2012</span><br>
        
      </div>

      <article class="post-content">
      <p>Go, by its very nature, is multithreaded. This makes a traditional approach of
daemonizing Go programs by forking a bit difficult.</p>
<p>To get around this, you could try something as simple as backgrounding your Go
program and instructing it to <a href="http://en.wikipedia.org/wiki/Nohup">ignore the HUP
signal</a>:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">nohup your-go-binary <span class="p">&amp;</span>
</code></pre></div><p>But what if your Go program is a web server that you need to be able to stop
and start?
(Particularly during development.)
It can quickly become a pain to use the above approach, as you'll have to look
up the process identifier each time you need to stop your server.
Moreover, using nohup isn't an ideal means to turn your program into a daemon,
since <a href="http://en.wikipedia.org/wiki/Daemon_(computing)#Creation">it doesn't accomplish tasks commonly associated with
daemons</a>, like
setting the root directory as the current working directory, setting the umask
to 0, and more.</p>
<p>In steps <a href="http://software.clapper.org/daemonize/">daemonize</a>, which runs any
command as a Unix daemon.
It automatically performs the aforementioned tasks and allows stdout and stderr
to be redirected to files of your choosing.
Here's a quick example usage:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">daemonize -o stdout.log -e stderr.log /absolute/path/to/go-program
</code></pre></div><p>While <code>daemonize</code> takes care of the nitty gritty details of becoming a daemon,
we still cannot start or stop our program as easily as we can with other common
daemons (like httpd, crond, cupsd, etc.).</p>
<p>In order to accomplish such a thing easily, it's usually convenient to mimmick
how other daemons are set up.</p>
<p>Since I use <a href="http://www.archlinux.org/">Archlinux</a>, my daemons
are organized in a BSD-style setup.
Namely, they are all located in <code>/etc/rc.d</code>.
Building off of the <code>/etc/rc.d/crond</code> daemon, I came up with the following for
the daemon powering this blog (located at <code>/etc/rc.d/blog-burntsushid</code>):</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash"><span class="cp">#!/bin/bash
</span><span class="cp"></span>
. /etc/rc.conf
. /etc/rc.d/functions

<span class="nv">name</span><span class="o">=</span>blog-burntsushi
<span class="nv">logOut</span><span class="o">=</span>/home/andrew/log/blog.stdout
<span class="nv">logErr</span><span class="o">=</span>/home/andrew/log/blog.stderr
<span class="nv">full</span><span class="o">=</span><span class="s2">&#34;/home/andrew/www/burntsushi.net/blog/blog&#34;</span>
<span class="nv">cmd</span><span class="o">=</span><span class="s2">&#34;</span><span class="s2">/usr/sbin/daemonize -o </span><span class="nv">$logOut</span><span class="s2"> -e </span><span class="nv">$logErr</span><span class="s2"> </span><span class="nv">$full</span><span class="s2">&#34;</span>
<span class="nv">user</span><span class="o">=</span><span class="s2">&#34;andrew&#34;</span>

<span class="c1"># Go environment setup.</span>
<span class="nb">export</span> <span class="nv">GOROOT</span><span class="o">=</span>/opt/go
<span class="nb">export</span> <span class="nv">GOPATH</span><span class="o">=</span>/home/andrew/go/world:/home/andrew/go/me
<span class="nb">export</span> <span class="nv">GOMAXPROCS</span><span class="o">=</span><span class="m">4</span>

<span class="c1"># You shouldn&#39;t have to edit below this line.</span>
<span class="nv">PID</span><span class="o">=</span><span class="k">$(</span>pidof -o %PPID <span class="nv">$full</span><span class="k">)</span>

<span class="k">case</span> <span class="s2">&#34;</span><span class="nv">$1</span><span class="s2">&#34;</span> in
start<span class="o">)</span>
	stat_busy <span class="s2">&#34;</span><span class="s2">Starting </span><span class="nv">$name</span><span class="s2"> daemon</span><span class="s2">&#34;</span>
	<span class="o">[</span><span class="o">[</span> -z <span class="s2">&#34;</span><span class="nv">$PID</span><span class="s2">&#34;</span> <span class="o">]</span><span class="o">]</span> <span class="o">&amp;&amp;</span> su <span class="nv">$user</span> -m -c <span class="s2">&#34;</span><span class="nv">$cmd</span><span class="s2">&#34;</span> <span class="p">&amp;</span>&gt;/dev/null <span class="se">\
</span><span class="se"></span>	<span class="o">&amp;&amp;</span> <span class="o">{</span> add_daemon <span class="nv">$name</span><span class="p">;</span> stat_done<span class="p">;</span> <span class="o">}</span> <span class="se">\
</span><span class="se"></span>	<span class="o">||</span> <span class="o">{</span> stat_fail<span class="p">;</span> <span class="nb">exit</span> 1<span class="p">;</span> <span class="o">}</span>
	<span class="p">;</span><span class="p">;</span>
stop<span class="o">)</span>
	stat_busy <span class="s2">&#34;</span><span class="s2">Stopping </span><span class="nv">$name</span><span class="s2"> daemon</span><span class="s2">&#34;</span>
	<span class="o">[</span><span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$PID</span><span class="s2">&#34;</span> <span class="o">]</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> <span class="nv">$PID</span> <span class="p">&amp;</span>&gt;/dev/null <span class="se">\
</span><span class="se"></span>	<span class="o">&amp;&amp;</span> <span class="o">{</span> rm_daemon <span class="nv">$name</span><span class="p">;</span> stat_done<span class="p">;</span> <span class="o">}</span> <span class="se">\
</span><span class="se"></span>	<span class="o">||</span> <span class="o">{</span> stat_fail<span class="p">;</span> <span class="nb">exit</span> 1<span class="p">;</span> <span class="o">}</span>
	<span class="p">;</span><span class="p">;</span>
reload<span class="o">)</span>
	stat_busy <span class="s2">&#34;</span><span class="s2">Reloading </span><span class="nv">$name</span><span class="s2"> daemon</span><span class="s2">&#34;</span>
	<span class="o">[</span><span class="o">[</span> -n <span class="s2">&#34;</span><span class="nv">$PID</span><span class="s2">&#34;</span> <span class="o">]</span><span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nb">kill</span> -HUP <span class="nv">$PID</span> <span class="p">&amp;</span>&gt;/dev/null <span class="se">\
</span><span class="se"></span>	<span class="o">&amp;&amp;</span> <span class="o">{</span> stat_done<span class="p">;</span> <span class="o">}</span> <span class="se">\
</span><span class="se"></span>	<span class="o">||</span> <span class="o">{</span> stat_fail<span class="p">;</span> <span class="nb">exit</span> 1<span class="p">;</span> <span class="o">}</span>
	<span class="p">;</span><span class="p">;</span>
restart<span class="o">)</span>
	<span class="nv">$0</span> stop
	sleep <span class="m">1</span>
	<span class="nv">$0</span> start
	<span class="p">;</span><span class="p">;</span>
*<span class="o">)</span>
	<span class="nb">echo</span> <span class="s2">&#34;</span><span class="s2">usage: </span><span class="nv">$0</span><span class="s2"> {start|stop|restart|reload}</span><span class="s2">&#34;</span>
	<span class="p">;</span><span class="p">;</span>
<span class="k">esac</span>
<span class="nb">exit</span> <span class="m">0</span>
</code></pre></div><p>Simply altering the environment variables at the top should be enough to adapt
it to your own purposes.
In particular, <code>$name</code> refers to the name of the daemon&mdash;it needn't correspond
to any actual file.
<code>$full</code> corresponds to the absolute path name of your Go binary.
(The path must be absolute because <code>daemonize</code> requires it.)
<code>$logOut</code> and <code>$logErr</code> correspond to the log files containing the stdout and
the stderr of your program.
<code>$cmd</code> corresponds to the full <code>daemonize</code> command.
<code>$user</code> is the name of the user that should run the daemon.
I've chosen to run my blog as myself for security purposes.
<code>$GOROOT</code>, <code>$GOPATH</code> and <code>$GOMAXPROCS</code> should be set according to your
Go environment.</p>
<p>Finally, the command is actually run using:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">su <span class="nv">$user</span> -m -c <span class="s2">&#34;</span><span class="nv">$cmd</span><span class="s2">&#34;</span>
</code></pre></div><p>Using <code>su</code> will run the daemon as the user you specified.
The <code>-m</code> switch tells <code>su</code> to use the current environment to run the command
in, which is required for the <code>$GO</code> variables to have any effect.</p>
<p>Your Go program can now be started, stopped or restarted like so:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">/etc/rc.d/blog-burntsushid start
/etc/rc.d/blog-burntsushid restart
/etc/rc.d/blog-burntsushid stop
</code></pre></div><p>The <a href="https://wiki.archlinux.org/index.php/Main_Page">Archlinux Wiki</a> has more
information on <a href="https://wiki.archlinux.org/index.php/Writing_rc.d_scripts">writing rc.d
scripts</a>.</p>
      </article>

      

    </div>
  </div>
</div>
    <footer class="footer">
      <div class="p2 wrap">
        <div class="measure mt1 center">
      <nav class="social-icons icons">
<a class="fa fa-rss rss" href="../index.xml"></a>

</nav>

          <small>
            All content is dual licensed under the UNLICENSE and MIT licenses.<br>
            Powered by <a href="http://gohugo.io/" target="_blank">Hugo</a> &amp; <a href="https://github.com/azmelanar/hugo-theme-pixyll" target="_blank">Pixyll</a>
          </small>
        </div>
      </div>
    </footer>
</body>
</html>

