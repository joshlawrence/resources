<!DOCTYPE html>
<html>
  <head>
    <title>
      Using Nginx to Provide SSL Access for POP3
    </title>
    <meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
    <link href='../main.css' rel='stylesheet' type='text/css'>
    <link href='../code.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <h3 style='margin-left: 5px; margin-top: 20px;'>
      <a href='../index.html' id='myname'>Eric Radman</a>
      <span id='mytitle'>: a Journal</span>
    </h3>
    <div id='article'>
      <h1>Using Nginx to Provide SSL Access for POP3</h1>
      <p>
        Nginx includes a very nice set of <a
        href="http://nginx.org/en/docs/mail/ngx_mail_core_module.html">proxy modules for
        common mail protocols</a> that provides a means of proving an SSL-tunnel to
        simple mail daemons that speak clear-text such as <em>solid-pop3d</em>. These
        modules are not compiled in the Nginx base install, but they are enabled if you
        install Nginx from ports. The following addition to <em>nginx.conf</em> will
        enable the <em>pop3s</em> to <em>pop</em> proxy:
      </p>
      <pre>&#x000A;mail {&#x000A;    server_name       vm.eradman.com;&#x000A;    auth_http         localhost:9000;&#x000A;&#x000A;    proxy               on;&#x000A;    ssl_protocols           TLSv1 SSLv3;&#x000A;    ssl_certificate         /etc/mail/certs/vm.eradman.com.crt;&#x000A;    ssl_certificate_key     /etc/mail/certs/vm.eradman.com.key;&#x000A;&#x000A;    pop3_auth         plain apop cram-md5;&#x000A;&#x000A;    server {&#x000A;        protocol    pop3;&#x000A;        listen      995;&#x000A;        ssl         on;&#x000A;        pop3_auth   plain;&#x000A;    }&#x000A;}&#x000A;</pre>
      <p>
        While debugging the following line may also prove useful information
      </p>
      <pre>&#x000A;error_log /var/log/nginx-error.log info;&#x000A;</pre>
      <p>
        The only manual assembly required is to establish a mechanism for
      </p>
      <em>
        auth_http</em> to use. Nginx will issue an HTTP GET to this service to
        request the parameters for the backend connection. Unfortunately Nginx doesn't
        have CGI support, so I resorted to writing a short script to be launched by
      </em>
      <em>
        inetd</em>
      </em>
      <pre>&#x000A;<span class="Comment">#!/bin/sh</span>&#x000A;<span class="Comment"># mailauth - Nginx mail director for inetd</span>&#x000A;&#x000A;<span class="Identifier">server</span>=<span class="Constant">127</span>.<span class="Constant">0</span>.<span class="Constant">0</span>.<span class="Constant">1</span>&#x000A;&#x000A;<span class="Statement">while </span><span class="Statement">read</span><span class="Statement"> header</span>&#x000A;<span class="Statement">do</span>&#x000A;    <span class="Identifier">line</span>=<span class="Statement">&quot;</span><span class="Error">$(</span><span class="Statement">echo</span><span class="Constant"> </span><span class="PreProc">$header</span><span class="Constant"> </span><span class="Statement">|</span><span class="Special"> tr </span><span class="Special">-d</span><span class="Special"> </span><span class="Statement">'</span><span class="Constant">\r</span><span class="Statement">'</span><span class="Error">)</span><span class="Statement">&quot;</span>&#x000A;    <span class="Statement">case</span> <span class="PreProc">$line</span> <span class="Statement">in</span>&#x000A;        <span class="Statement">&quot;</span><span class="Constant">Auth-Protocol: pop3</span><span class="Statement">&quot;</span><span class="Statement">)</span> <span class="Identifier">port</span>=<span class="Constant">110</span><span class="Statement">;;</span>&#x000A;        <span class="Statement">&quot;</span><span class="Constant">Auth-Protocol: imap</span><span class="Statement">&quot;</span><span class="Statement">)</span> <span class="Identifier">port</span>=<span class="Constant">143</span><span class="Statement">;;</span>&#x000A;        <span class="Statement">&quot;</span><span class="Constant">Auth-Protocol: smtp</span><span class="Statement">&quot;</span><span class="Statement">)</span> <span class="Identifier">port</span>=<span class="Constant">25</span><span class="Statement">;;</span>&#x000A;        <span class="Statement">&quot;&quot;</span><span class="Statement">)</span> <span class="Statement">break</span>&#x000A;    <span class="Statement">esac</span>&#x000A;<span class="Statement">done</span>&#x000A;&#x000A;<span class="Statement">print</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Constant">HTTP/1.1 200 OK</span><span class="Special">\r</span><span class="Statement">&quot;</span>&#x000A;<span class="Statement">print</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Constant">Content-type: text/plain</span><span class="Special">\r</span><span class="Statement">&quot;</span>&#x000A;<span class="Statement">print</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Constant">Auth-Status: OK</span><span class="Special">\r</span><span class="Statement">&quot;</span>&#x000A;<span class="Statement">print</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Constant">Auth-Server: </span><span class="PreProc">${</span><span class="PreProc">server</span><span class="PreProc">}</span><span class="Special">\r</span><span class="Statement">&quot;</span>&#x000A;<span class="Statement">print</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Constant">Auth-Port: </span><span class="PreProc">${</span><span class="PreProc">port</span><span class="PreProc">}</span><span class="Special">\r</span><span class="Statement">&quot;</span>&#x000A;<span class="Statement">print</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Special">\r</span><span class="Statement">&quot;</span>&#x000A;<span class="Statement">echo</span><span class="Constant"> OK</span>&#x000A;</pre>
      <p>
        This shell script returns <em>127.0.0.1</em> as the authentication server and
        a port number appropriate for each local service. Run it from <em>inetd</em> by
        making the following config changes
      </p>
      <pre>&#x000A;<span class="Comment"># /etc/services</span>&#x000A;<span class="Identifier">mailauth</span>        <span class="Constant">9000</span><span class="Special">/</span><span class="Type">tcp</span>                <span class="Comment"># nginx mail proxy</span>&#x000A;</pre>
      <pre>&#x000A;# /etc/inetd.conf&#x000A;pop3            stream  tcp     nowait  root    /usr/sbin/popa3d        popa3d&#x000A;mailauth        stream  tcp     nowait  root    /var/www/cgi-bin/mailauth mailauth</pre>
    </div>
    <p class='timestamp'>
      Last updated on November 26, 2016
    </p>
  </body>
</html>
