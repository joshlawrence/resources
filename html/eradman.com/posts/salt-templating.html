<!DOCTYPE html>
<html>
  <head>
    <title>
      Advanced Salt Templates
    </title>
    <meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
    <link href='../main.css' rel='stylesheet' type='text/css'>
    <link href='../code.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <h3 style='margin-left: 5px; margin-top: 20px;'>
      <a href='../index.html' id='myname'>Eric Radman</a>
      <span id='mytitle'>: a Journal</span>
    </h3>
    <div id='article'>
      <h1>Advanced Salt Templates</h1>
      <h2>Dynamic Rules</h2>
      <p>
        Any system for configuration management can apply discovered facts to
        a template in order to generate files, but Salt is perhaps a step ahead in
        that the every SLS file is itself a template. This means that the rules that
        describe what files to process can be dynamic.
      </p>
      <pre>&#x000A;<span class="Special">{</span>% for host in <span class="Special">[</span><span class="Constant">'</span><span class="Constant">www1</span><span class="Constant">'</span>, <span class="Constant">'</span><span class="Constant">www2</span><span class="Constant">'</span><span class="Special">]</span> %<span class="Special">}</span>&#x000A;<span class="Identifier">/var/www/html/coreos/{{host}}.yml</span><span class="Special">:</span>&#x000A;  <span class="Identifier">file.managed</span><span class="Special">:</span>&#x000A;    <span class="Statement">- </span><span class="Identifier">source</span><span class="Special">:</span> salt://coreos/could-init.yml&#x000A;    <span class="Statement">- </span><span class="Identifier">template</span><span class="Special">:</span> jinja2&#x000A;    <span class="Statement">- </span><span class="Identifier">context</span><span class="Special">:</span>&#x000A;      <span class="Identifier">hostname</span><span class="Special">:</span> <span class="Special">{{</span>host<span class="Special">}}</span>&#x000A;<span class="Special">{</span>% endfor %<span class="Special">}</span>&#x000A;</pre>
      <h2>Extending Salt</h2>
      <p>
        Salt will parse python modules found in the <em>_modules</em> directory. this
        enables us to drive rule creation based on arbitray logic. In this example a
        we define a function for generating a list of hosts.
      </p>
      <pre>&#x000A;  <span class="Comment"># util.py</span>&#x000A;  <span class="PreProc">import</span> hostlist&#x000A;&#x000A;  <span class="Statement">def</span> <span class="Identifier">expand_hostlist</span>(spec):&#x000A;      <span class="Statement">return</span>  hostlist.expand_hostlist(spec)&#x000A;</pre>
      <p>
        Now in a SLS file or any template we can call this new functionality that was
        added by Salt.
      </p>
      <pre>&#x000A;<span class="Special">{</span>% set hosts = salt<span class="Special">[</span><span class="Constant">'</span><span class="Constant">util.expand_hostlist</span><span class="Constant">'</span><span class="Special">]</span>('www<span class="Special">[</span>01-99<span class="Special">]</span><span class="Constant">'</span><span class="Constant">) %}</span>&#x000A;</pre>
      <p>
        For other state information that is available see the
        <a href="https://docs.saltstack.com/en/latest/ref/states/vars.html">
        SLS Temmplate Variable Reference</a>. It's worth nothing that the filename of
        the template being generated is always available as the variable <em>name</em>.
        Also, in the SLS file we passed in <em>context</em> which contained the short
        hostname of it is rendering. This is very powerful, and allows us to build
        very generic templates that rely on information supplied in the loop.
      </p>
      <p>
        We are now very close to a complete system that could be used for bare-metal
        provisioning. Installing an individual host could be as easy as
      </p>
      <pre>&#x000A;$ salt &quot;server1&quot; state.sls_id /var/www/html/coreos/www1.yml coreos&#x000A;</pre>
      <h2>Raw Python</h2>
      <p>
        There is a lot that can be done with jinja2 templates + custom Salt modules,
        but Salt also supports processing files by executing Python
      </p>
      <pre>&#x000A;<span class="Special">{</span>% for host in <span class="Special">[</span><span class="Constant">'</span><span class="Constant">www1</span><span class="Constant">'</span>, <span class="Constant">'</span><span class="Constant">www2</span><span class="Constant">'</span><span class="Special">]</span> %<span class="Special">}</span>&#x000A;<span class="Identifier">/var/www/html/coreos/{{host}}.yml</span><span class="Special">:</span>&#x000A;  <span class="Identifier">file.managed</span><span class="Special">:</span>&#x000A;    <span class="Statement">- </span><span class="Identifier">source</span><span class="Special">:</span> salt://coreos/could-init.py&#x000A;    <span class="Statement">- </span><span class="Identifier">template</span><span class="Special">:</span> py&#x000A;<span class="Special">{</span>% endfor %<span class="Special">}</span></pre>
    </div>
    <p class='timestamp'>
      Last updated on October 04, 2016
    </p>
  </body>
</html>
