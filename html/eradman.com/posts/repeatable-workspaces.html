<!DOCTYPE html>
<html>
<head>
<title>
Repeatable Workspaces

</title>
<meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
<link href='../main.css' rel='stylesheet' type='text/css'>
<link href='../code.css' rel='stylesheet' type='text/css'>
</head>
<body>
<h3 style='margin-left: 5px; margin-top: 20px;'>
<a href='../index.html' id='myname'>Eric Radman</a>
<span id='mytitle'>: a Journal</span>
</h3>
<div id='article'>
<h1>Repeatable Workspaces</h1>
<p>
In software engineering a repeatable configuration is critical to testing, but
a repeatable environment is not a
<em>clean</em>
environment. A test that tries too hard to eliminate environmental differences
may also be allowing the software to make assumptions that don't hold when
deployed in the wild. Therefore a repeatable test harness allows the same
software to be reliably tested in a variety of platforms and environments.
</p>
<p>
A similar, but not equivalent benefit exists for creating a workspace that
can be re-instantiated.
<a href='https://github.com/tmux/tmux/wiki'>tmux</a>
gives you the capability to recreate the session you work in so that you can
get back to work after a power outage or even after refreshing
<a href='https://man.openbsd.org/ssh-agent'>ssh-agent</a>.
</p>
<h2>The Loop</h2>
<p>
Speaking of
<code>ssh-agent</code>,
the fist thing I want to do is assert that it's running
</p>
<pre>&#x000A;<span class="Comment">#!/bin/sh -x</span>&#x000A;<span class="Comment"># Start development environment in tmux</span>&#x000A;&#x000A;<span class="Statement">test</span> <span class="Special">-S</span> <span class="PreProc">${</span><span class="PreProc">SSH_AUTH_SOCK</span><span class="Statement">:-</span><span class="Error">/dev</span><span class="PreProc">}</span> || <span class="Special">{</span> <span class="Statement">echo</span><span class="Constant"> </span><span class="Statement">&quot;</span><span class="Constant">ssh-agent not running</span><span class="Statement">&quot;</span><span class="Statement">;</span> <span class="Statement">exit</span> <span class="Constant">1</span><span class="Statement">;</span> <span class="Special">}</span></pre>
<p>
Next, spin up a new
<code>tmux</code>
session with some windows
</p>
<pre>&#x000A;<span class="Identifier">session</span>=main&#x000A;<span class="Identifier">editor</span>=<span class="PreProc">${</span><span class="PreProc">EDITOR</span><span class="Statement">:-</span><span class="Error">vim</span><span class="PreProc">}</span>&#x000A;&#x000A;<span class="Comment"># start new session, disconnected</span>&#x000A;tmux new-session <span class="Special">-s</span> <span class="Statement">&quot;</span><span class="PreProc">$session</span><span class="Statement">&quot;</span> <span class="Special">-d</span>&#x000A;</pre>
<pre>&#x000A;<span class="Statement">for</span> n <span class="Statement">in</span> <span class="Constant">0</span> <span class="Constant">1</span>; <span class="Statement">do</span>&#x000A;<span class="Identifier">window</span>=<span class="PreProc">$session</span>:<span class="PreProc">$n</span>&#x000A;<span class="Statement">case</span> <span class="PreProc">$n</span> <span class="Statement">in</span>&#x000A;    0<span class="Statement">)</span>&#x000A;        tmux rename-window <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">saltm</span><span class="Statement">&quot;</span>&#x000A;        <span class="Statement">;;</span>&#x000A;    1<span class="Statement">)</span>&#x000A;        tmux new-window <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Special">-n</span> <span class="Statement">&quot;</span><span class="Constant">salt-devel</span><span class="Statement">&quot;</span>&#x000A;        <span class="Statement">;;</span>&#x000A;<span class="Statement">esac</span>&#x000A;<span class="Statement">done</span>&#x000A;&#x000A;<span class="Comment"># Switch to first window and attach to session</span>&#x000A;tmux select-window <span class="Special">-t</span> <span class="PreProc">$session</span>:<span class="Constant">0</span>&#x000A;tmux <span class="Constant">-2</span> attach-session <span class="Special">-t</span> <span class="Statement">&quot;</span><span class="PreProc">$session</span><span class="Statement">&quot;</span>&#x000A;</pre>
<p>
I create a new window for each major project or major operation that I'm in
working on. All of the tmux commands such as
<code>rename-window</code>
and
<code>split-window</code>
that work from a script provided you specify the session name and window
number. Here I split virtically, ssh to a development checkout, and activate
a Python virtual environment
</p>
<pre>&#x000A;    <span class="Constant">0</span><span class="Error">)</span>&#x000A;      tmux rename-window <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">saltm</span><span class="Statement">&quot;</span>&#x000A;      tmux send-keys <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">ssh ensaltm1</span><span class="Statement">&quot;</span> C-m&#x000A;      tmux send-keys <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">. ~/local/saltenv/bin/activate</span><span class="Statement">&quot;</span> C-m&#x000A;      tmux send-keys <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">cd ~/git/salt</span><span class="Statement">&quot;</span> C-m&#x000A;      tmux split-window <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Special">-h</span> <span class="Special">-p</span> <span class="Constant">50</span>&#x000A;      tmux send-keys <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">ssh dhmsaltm1</span><span class="Statement">&quot;</span> C-m&#x000A;      tmux send-keys <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">. ~/local/saltenv/bin/activate</span><span class="Statement">&quot;</span> C-m&#x000A;      tmux send-keys <span class="Special">-t</span> <span class="PreProc">$window</span> <span class="Statement">&quot;</span><span class="Constant">cd ~/git/salt</span><span class="Statement">&quot;</span> C-m&#x000A;      tmux select-pane <span class="Special">-t</span> <span class="PreProc">$window</span>.<span class="Constant">0</span>&#x000A;      ;</pre>
<p>
To assist with the testing of the script itself you may want to destroy the
window after detaching
</p>
<pre>&#x000A;tmux <span class="Constant">-2</span> attach-session <span class="Special">-t</span> <span class="Statement">&quot;</span><span class="PreProc">$session</span><span class="Statement">&quot;</span>&#x000A;<span class="Comment"># user exited, destroy</span>&#x000A;tmux kill-session <span class="Special">-t</span> <span class="Statement">&quot;</span><span class="PreProc">$session</span><span class="Statement">&quot;</span></pre>

</div>
<p class='timestamp'>
Last updated on August 09, 2017
</p>
</body>
</html>
