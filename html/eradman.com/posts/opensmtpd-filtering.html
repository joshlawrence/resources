<!DOCTYPE html>
<html>
  <head>
    <title>
      OpenSMTPD Mail Filtering
    </title>
    <meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
    <link href='../main.css' rel='stylesheet' type='text/css'>
    <link href='../code.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <h3 style='margin-left: 5px; margin-top: 20px;'>
      <a href='../index.html' id='myname'>Eric Radman</a>
      <span id='mytitle'>: a Journal</span>
    </h3>
    <div id='article'>
      <h1>OpenSMTPD Mail Filtering</h1>
      <p>
        The title of this post should be "Spam Filtering on OpenSMTPD", but I didn't
        want to use the word "spam" on my home page. Running an e-mail server is a
        challanging and low-reward task, so we need to keep this as simple as we
        possibly can.  These days is I classify mail using <a
        href="https://spamassassin.apache.org">SpamAssasin</a>, which will retuire
        three packages
      </p>
      <pre>&#x000A;p5-Mail-SpamAssassin&#x000A;spampd&#x000A;procmail&#x000A;</pre>
      <p>
        <em>SpamAssassin</em> is the classification engine, <em>SpamPD</em> connects
        to the SpamAssassin daemon and forwards the mail to an MTA, and
        <em>Procmail</em> writes the messages in the <em>mbox</em> format.
      </p>
      <h2>SpamAssassin &amp; SpamPD</h2>
      <p>
        Filtering mail with OpenSMTPd is most easily accomplished by running a
        SpamAssassin proxy that we can forward mail to. The SpamPD relay will
        add <em>X-Spam-</em> headers to each message and forwarded them back to
        localhost on the port that we specify
      </p>
      <pre>&#x000A;<span class="Comment"># rc.conf.local</span>&#x000A;<span class="Identifier">pkg_scripts</span>=<span class="Statement">&quot;</span><span class="Constant">spamassassin spampd</span><span class="Statement">&quot;</span>&#x000A;<span class="Identifier">spampd_flags</span>=<span class="Statement">&quot;</span><span class="Constant">--port=10025 --relayhost=127.0.0.1:10026 --tagall --log-rules-hit --maxsize=2048</span><span class="Statement">&quot;</span>&#x000A;</pre>
      <p>
        These <a
        href="http://www.worlddesign.com/Content/rd/mta/spampd/spampd.html">SpamPD
        options</a> only need to match the MTA configuration. Setting
        <em>--maxsize</em> allows messages with largish attachments to be
        processed. <em>--tagall</em> and <em>--log-rules-hit</em> are not
        required, but useful for diagnostics.
      </p>
      <h2>Procmail</h2>
      <p>
        Procmail can be configured per user with <em>$HOME/.procmailrc</em> or per
        site with <em>/etc/procmailrc</em>.  The following rules will cause suspect
        mail to be delivered to an mbox named "spam".
      </p>
      <pre>&#x000A;<span class="Statement">:0:</span>&#x000A;* ^X-Spam-Flag: YES&#x000A;<span class="Identifier">$HOME</span><span class="Statement">/mail/spam</span>&#x000A;</pre>
      <h2>OpenSMTPD Routing</h2>
      <p>
        Extending the ideas presented in <a
        href="run-your-own-server.html">Run Your Own Server</a>, this adds routing
        rules that forward incoming mail to the mail proxy for evaluation
      </p>
      <pre>&#x000A;<span class="Comment"># smtpd.conf</span>&#x000A;listen on localhost port <span class="Constant">25</span>&#x000A;listen on egress port <span class="Constant">25</span>&#x000A;listen on localhost port <span class="Constant">10028</span> tag DKIM&#x000A;listen on localhost port <span class="Constant">10026</span> tag SPAMD&#x000A;&#x000A;<span class="Statement">table</span> aliases db:/etc/<span class="Constant">mail</span>/aliases.db&#x000A;&#x000A;accept tagged SPAMD from <span class="Type">any</span> for <span class="Constant">domain</span> &quot;eradman.com&quot; deliver to mda &quot;procmail -f -&quot;&#x000A;accept from <span class="Type">any</span> for <span class="Constant">domain</span> &quot;eradman.com&quot; relay via <span class="Constant">smtp</span>:/<span class="Constant">/127</span>.0.0.1:10025&#x000A;accept for local alias <span class="Identifier">&lt;aliases&gt;</span> deliver to mbox&#x000A;&#x000A;accept tagged DKIM for <span class="Type">any</span> relay&#x000A;accept from local for <span class="Type">any</span> relay via <span class="Constant">smtp</span>:/<span class="Constant">/127</span>.0.0.1:10027&#x000A;</pre>
      <p>
        Incoming mail on port <em>25</em> is not tagged, which matches the rule
        <em>relay via smtp://127.0.0.1:10025</em>. After SpamAssassin grades the mail,
        SpamPD relays it back to OpenSMTPD on port <em>10026</em> where it matches the
        tag <em>SPAMD</em> and is handed over to <em>procmail</em> for delivery.
      </p>
    </div>
    <p class='timestamp'>
      Last updated on March 04, 2017
      <br>
      <a href='https://bitbucket.org/eradman/eradman.com'>eradman.com/source</a>
    </p>
  </body>
</html>
