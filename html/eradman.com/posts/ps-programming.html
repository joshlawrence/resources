<!DOCTYPE html>
<html>
  <head>
    <title>
      Dynamic Paper Pages
    </title>
    <meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
    <link href='../main.css' rel='stylesheet' type='text/css'>
    <link href='../code.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <h3 style='margin-left: 5px; margin-top: 20px;'>
      <a href='../index.html' id='myname'>Eric Radman</a>
      <span id='mytitle'>: a Journal</span>
    </h3>
    <div id='article'>
      <h1>Dynamic Paper Pages</h1>
      <h2>Generating PostScript</h2>
      <p>
        The World Wide Web is based on a few document standards (HTML, CSS) and a
        few protocols (DNS, HTTP, HTTPS). Historically the printed content is (or
        should be) described by a language called PostScript. Only high-end ink-jets
        support PS, but it's common for lasers to have an interpreter built in. The
        reason PostScript is so important is because it's a standardized way to
        producing printed documents. Unlike HTML, PS is an interpreted programming
        language, and it produces exact results.
      </p>
      <p>
        So how do we generate PostScript?
      </p>
      <table>
        <tr>
          <td>
            Web Browser
          </td>
          <td>
            Build an HTML report. This solution requires some considerable effort if
            predictable output is required.
          </td>
        </tr>
        <tr>
          <td>
            TeX
          </td>
          <td>
            TeX is a macro language available on UNIX systems since the beginning of
            time: it was put into production on the PDP-10. Features excellent
            typesetting capabilities, but is very hard to script for.  Unlike XML, the
            generation logic required to produce <em>.tex</em> files must handle many
            peculiar exceptions, and has requires case-by-case scring translations to
            make input sane in each particular context.
          </td>
        </tr>
        <tr>
          <td>
            Docbook XML
          </td>
          <td>
            Popular among open-source projects such as FreeBSD, KDE, GNOME, etc. Oddly
            enough it's better at producing HTML than PS. Why? Because like most
            document system, it relies on LaTeX/teTeX to generate PS, and current
            DocBook only understands a few formating constructs.
          </td>
        </tr>
        <tr>
          <td>
            Lout
          </td>
          <td>
            Designed for the generation of page generation and PS output only. Simple,
            consistent API that is easy to build using almost any generic (non-XML)
            templating system. This is the method I use most often.
          </td>
        </tr>
      </table>
      <h2>Including Graphics</h2>
      <p>
        Any valid EPS file can be included in a Lout document, and any application
        that can print to file can be used to generate a PS file.  After printing use
        <em>eps2eps</em> to convert this to a PS file that can be embedded:
      </p>
      <pre>&#x000A;% eps2eps page_header.ps page_header.eps&#x000A;</pre>
      <p>
        Then run <em>gs</em> to find the real bounds of the graphic:
      </p>
      <pre>&#x000A;% gs -sDEVICE=bbox -dNOPAUSE -dBATCH page_header.eps&#x000A;&#x000A;%%BoundingBox: 65 659 512 758&#x000A;%%HiResBoundingBox: 65.183496 659.745015 511.434507 757.700656&#x000A;</pre>
      <p>
        Plug these figures in at the top of the <em>.eps</em> file and it
        will now be sized correctly for inclusion in another document.
      </p>
      <p>
        Alternatively use the <em>ps2epsi</em> utility included with
        GhostScript:
      </p>
      <pre>&#x000A;% ps2epsi page_header.ps page_header.eps&#x000A;</pre>
      <p>
        Similarly, ImageMagick's <em>convert</em> command can be used to
        convert a <em>.png</em> file retreaved from the web:
      </p>
      <pre>&#x000A;$ wget <a href="http://us300-ob0.teisprint.net/mrtg/72.20.214.6_fa0_6-week.png">http://us300-ob0.teisprint.net/mrtg/72.20.214.6_fa0_6-week.png</a> -O this_week.png&#x000A;$ convert this_week.png this_week.ps&#x000A;</pre>
      <p class='center'>
        <img src="../library/ps-programming/this_week.png" alt="Graph" width="500" height="135" />
      </p>
      <h2>Building a Basic Lout Document</h2>
      <p>
        Now that I've worked out the means for obtaining and including some of my
        graphic content, I draft and test a static document.
      </p>
      <pre>&#x000A;<span class="PreProc">@SysInclude{ doc }</span>&#x000A;<span class="PreProc">@SysInclude { tbl }</span>&#x000A;<span class="Statement">@Document</span>&#x000A;<span class="PreProc">//</span>&#x000A;<span class="Identifier">@Text</span> <span class="Statement">@Begin</span>&#x000A;&#x000A;<span class="Identifier">@IncludeGraphic</span> <span class="Special">&quot;page_header.eps&quot;</span>&#x000A;&#x000A;<span class="Identifier">@CD</span>&#x000A;<span class="Identifier">@Heading</span> <span class="Special">&quot;Monthly bandwidth graph for December&quot;</span>&#x000A;&#x000A;<span class="Identifier">@CD</span>&#x000A;0.7 <span class="Identifier">@Scale</span> <span class="Identifier">@IncludeGraphic</span> <span class="Special">&quot;this_week.eps&quot;</span>&#x000A;&#x000A;<span class="Identifier">@CD</span>&#x000A;<span class="Identifier">@Heading</span> <span class="Special">&quot;Charges&quot;</span>&#x000A;&#x000A;<span class="Identifier">@CD</span> 10c <span class="Identifier">@Wide</span> <span class="Identifier">@Tbl</span>&#x000A;    rule<span class="Special">{</span>yes<span class="Special">}</span>&#x000A;    aformat <span class="Special">{</span> <span class="Identifier">@Cell</span> A | <span class="Identifier">@Cell</span> B <span class="Special">}</span>&#x000A;<span class="Special">{</span>&#x000A;<span class="Identifier">@Rowa</span> A <span class="Special">{</span> Colocation, 2U: <span class="Special">}</span>  B <span class="Special">{</span> $50.00 <span class="Special">}</span>&#x000A;<span class="Identifier">@Rowa</span> A <span class="Special">{</span> Bandwidth: <span class="Special">}</span>       B <span class="Special">{</span> $95.00 <span class="Special">}</span>&#x000A;<span class="Identifier">@Rowa</span> A <span class="Special">{</span> Backup Services: <span class="Special">}</span> B <span class="Special">{</span> $15.00 <span class="Special">}</span>&#x000A;<span class="Identifier">@Rowa</span> A <span class="Special">{</span> <span class="loutBold">@B Total</span>: <span class="Special">}</span>        B <span class="Special">{</span> <span class="Identifier">@B</span> $160.00 <span class="Special">}</span>&#x000A;<span class="Special">}</span>&#x000A;&#x000A;<span class="Statement">@End</span> <span class="Identifier">@Text</span>&#x000A;&#x000A;</pre>
      <p>
        Interpret and view:
      </p>
      <pre>&#x000A;$ lout report.lout &gt; report.ps &amp;&amp; gv report.ps&#x000A;</pre>
      <h2>Dynamic Page Generation</h2>
      <p>
        Once the layout for the presentation looks good copy the static document and
        plug in some logic and values with your favorite templating language. This is
        using eRuby:
      </p>
      <pre>&#x000A;<span class="PreProc">&lt;%</span> total = <span class="Constant">0</span> <span class="PreProc">%&gt;</span>&#x000A;<span class="PreProc">&lt;%</span> <span class="Statement">for</span> service <span class="Statement">in</span> services <span class="PreProc">%&gt;</span>&#x000A;@Rowa A { <span class="PreProc">&lt;%=</span> service[<span class="Special">'</span><span class="Constant">description</span><span class="Special">'</span>] <span class="PreProc">%&gt;</span> }  B { <span class="PreProc">&lt;%=</span> service[<span class="Special">'</span><span class="Constant">price</span><span class="Special">'</span>] <span class="PreProc">%&gt;</span> }&#x000A;<span class="PreProc">&lt;%</span> total = total + service[<span class="Special">'</span><span class="Constant">price</span><span class="Special">'</span>] <span class="PreProc">%&gt;</span>&#x000A;<span class="PreProc">&lt;%</span> <span class="Statement">end</span> <span class="PreProc">%&gt;</span>&#x000A;@Rowa A { @B Total: }        B { @B <span class="PreProc">&lt;%=</span> total <span class="PreProc">%&gt;</span> }&#x000A;&#x000A;</pre>
      <p>
        The Ruby script that imports this template is tasked with pulling the right
        information from the database, downloading the correct graph for that customer,
        running Lout to product the PostScript output, and finally with calling
        <em>lpr</em> to print the document.
      </p>
      <p>
        First import the template, cgi, and database support:
      </p>
      <pre>&#x000A;<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">eruby</span><span class="Special">&quot;</span>&#x000A;<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">cgi</span><span class="Special">&quot;</span>&#x000A;<span class="PreProc">require</span> <span class="Special">&quot;</span><span class="Constant">dbi</span><span class="Special">&quot;</span>&#x000A;</pre>
      <p>
        Next instantate a CGI class for parsing arguments and pull the relavant
        recods from the database:
      </p>
      <pre>&#x000A;cgi = <span class="Type">CGI</span>.new&#x000A;id = Integer(cgi[<span class="Special">'</span><span class="Constant">id</span><span class="Special">'</span>])&#x000A;dbh = <span class="Type">DBI</span>.connect(<span class="Special">'</span><span class="Constant">DBI:Pg:system</span><span class="Special">'</span>)&#x000A;&#x000A;conn = dbh.prepare(<span class="Special">&quot;</span><span class="Constant">SELECT * FROM services(?)</span><span class="Special">&quot;</span>)&#x000A;conn.execute(id)&#x000A;services = conn.fetch_all&#x000A;&#x000A;</pre>
      <p>
        Finally generate the doucment and print it!
      </p>
      <pre>&#x000A;puts <span class="Special">&quot;</span><span class="Constant">Content-Type: text/plain</span><span class="Special">&quot;</span>&#x000A;puts&#x000A;puts <span class="Special">&quot;</span><span class="Constant">Processing customer (</span><span class="Special">#{</span>id<span class="Special">}</span><span class="Constant">)</span><span class="Special">&quot;</span>&#x000A;puts&#x000A;puts <span class="Special">&quot;</span><span class="Constant">  Building Template... [eruby]</span><span class="Special">&quot;</span>&#x000A;<span class="Special">`</span><span class="Constant">wget <a href="http://us300-ob0.teisprint.net/mrtg/">http://us300-ob0.teisprint.net/mrtg/</a></span><span class="Special">#{</span>service[<span class="Special">'</span><span class="Constant">graph</span><span class="Special">'</span>]<span class="Special">}</span><span class="Constant"> -O this_week.png</span><span class="Special">`</span>&#x000A;<span class="Special">`</span><span class="Constant">convert this_week.png this_week.ps</span><span class="Special">`</span>&#x000A;saved_stdout = <span class="Identifier">$stdout</span>&#x000A;output = <span class="Type">File</span>.open(<span class="Special">&quot;</span><span class="Constant">envalope.l</span><span class="Special">&quot;</span>,<span class="Special">&quot;</span><span class="Constant">w</span><span class="Special">&quot;</span>)&#x000A;<span class="Identifier">$stdout</span> = output&#x000A;    <span class="Type">ERuby</span>::import(<span class="Special">'</span><span class="Constant">report.rl</span><span class="Special">'</span>)&#x000A;output.close&#x000A;<span class="Identifier">$stdout</span> = saved_stdout&#x000A;puts <span class="Special">&quot;</span><span class="Constant">  Rendering...         [lout]</span><span class="Special">&quot;</span>&#x000A;<span class="Special">`</span><span class="Constant">/usr/pkg/bin/lout report.l &gt; report.ps</span><span class="Special">`</span>&#x000A;<span class="Special">`</span><span class="Constant">lpr -P8440 -h envalope.ps</span><span class="Special">`</span>&#x000A;&#x000A;puts&#x000A;puts <span class="Special">&quot;</span><span class="Constant">Done.</span><span class="Special">&quot;</span>&#x000A;</pre>
      <p class='center'>
        <img src="../library/ps-programming/colo-example.png" alt="Example Colocation Report" width="553" height="496" />
      </p>
    </div>
    <p class='timestamp'>
      Last updated on November 26, 2016
    </p>
  </body>
</html>
