<!DOCTYPE html>
<html>
  <head>
    <title>
      BSD: Networking Included
    </title>
    <meta content='text/html; charset=US-ASCII' http-equiv='Content-Type'>
    <link href='../main.css' rel='stylesheet' type='text/css'>
    <link href='../code.css' rel='stylesheet' type='text/css'>
  </head>
  <body>
    <h3 style='margin-left: 5px; margin-top: 20px;'>
      <a href='../index.html' id='myname'>Eric Radman</a>
      <span id='mytitle'>: a Journal</span>
    </h3>
    <div id='article'>
      <h1>BSD: Networking Included</h1>
      <p>
        These are some every-day techniques that I use to get stuff done.
      </p>
      <h2>XTerm is Useful</h2>
      <p>
        My first recommendation is to use a fast terminal with a bitmap font. The
        reason I say bitmap is because it will keep up with the display of a live
        capture.
        <p class="center"><img src="../library/networking-included/xterm.png" width="509"
        height="326" alt="XTerm screen shot" />
      </p>
      <h2>
        BSD Kernels track Duplicate IPs
      </h2>
      <p>
        The BSD kernels keep track of MAC-IP resolutions, and will log any changes.
        It's a good habit to check this after plugging your own laptop into a network.
        More than once I have plugged my Thinkpad into a network and broken some
        service because their DHCP server gave me an address that was already used.
      </p>
      <pre>&#x000A;$ dmesg&#x000A;...&#x000A;duplicate IP address 31.6.2.3 sent from ethernet address 00:13:72:a7:ff:14&#x000A;duplicate IP address 31.6.2.3 sent from ethernet address 00:13:72:a7:ff:14&#x000A;duplicate IP address 31.6.2.11 sent from ethernet address 00:13:72:a7:f9:04&#x000A;duplicate IP address 31.6.2.11 sent from ethernet address 00:13:72:a7:f9:04&#x000A;</pre>
      <ul>
        <li>Always check after guessing at an IP</li>
        <li>Always check this after an IT guy has assigned you one</li>
        <li>Don't trust DHCP assignments</li>
        <li>IPv6 should not suffer from duplicates often, but IT people will make it happen</li>
      </ul>
      <h2>Run Daemons as Foreground Processes</h2>
      <p>
        Most BSD network daemon can be run in the foreground, which not only gives
        you the ability to easily test a service again, but you may notice oddities
        immediately. Below is an example of a site that was configured with two
        competing DHCP servers.
      </p>
      <pre>&#x000A;$ sudo dhclient -d fxp0&#x000A;DHCPREQUEST on fxp0 to 255.255.255.255 port 67&#x000A;DHCPNAK from 31.6.1.4&#x000A;DHCPDISCOVER on fxp0 to 255.255.255.255 port 67 interval 7&#x000A;DHCPOFFER from 31.6.1.4&#x000A;DHCPOFFER from 31.6.1.3&#x000A;DHCPREQUEST on fxp0 to 255.255.255.255 port 67&#x000A;DHCPACK from 31.6.1.4&#x000A;bound to 31.6.2.11 -- renewal in 345600 seconds.&#x000A;</pre>
      <h2>Resolve Common Ports</h2>
      <p>
        <em>services</em> is a handy reference for common protocols.
      </p>
      <pre>&#x000A;$ grep 138 /etc/services&#x000A;netbios-dgm     138/tcp                         # NETBIOS Datagram Service&#x000A;netbios-dgm     138/udp&#x000A;</pre>
      <p>
        I also sometimes document an assignment by defining in
      </p>
      <em>
        <!-- etc/services</em>, so that I know what port is used, especially on -->
        proprietary systems.
      </em>
      <pre>&#x000A;coral     11001/tcp  # Coral PBX management with CUGW&#x000A;</pre>
      <h2>Quickly Find Proxy-Arp</h2>
      <p>
        This is insane; sometimes home-office routers are installed that have
        proxy-ARP enabled by default!(Linksys VPN routers come to mind.) A quick look
        at the ARP table will show this.
      </p>
      <pre>&#x000A;$ arp -a&#x000A;? (192.168.1.36) at 00:0c:6e:41:e1:56 on xl2&#x000A;? (192.168.1.43) at 00:0c:6e:41:e1:56 on xl2&#x000A;? (192.168.1.46) at 00:0c:6e:41:e1:56 on xl2&#x000A;? (192.168.1.49) at 00:0c:6e:41:e1:56 on xl2&#x000A;? (192.168.1.51) at 00:0c:6e:41:e1:56 on xl2&#x000A;? (192.168.1.56) at 00:0c:6e:41:e1:56 on xl2&#x000A;? (192.168.6.38) at 00:50:ba:58:9e:64 on xl1&#x000A;? (192.168.6.13) at 00:11:09:c5:cb:8b on xl1&#x000A;? (192.168.6.17) at 00:13:72:d3:da:94 on xl1&#x000A;? (192.168.6.18) at 00:0a:6b:00:a5:8b on xl1&#x000A;</pre>
      <h2>Is Someone Else using an IP?</h2>
      <p>
        Again, never trust IP assignments, and if I need to assign an IP it's wise
        to make sure no network card is responding to it.
      </p>
      <pre>&#x000A;$ ping -c 1 -n 72.20.216.78&#x000A;PING 72.20.216.78 (72.20.216.78): 56 data bytes&#x000A;&#x000A;/--- 72.20.216.78 ping statistics ---&#x000A;1 packets transmitted, 0 packets received, 100.0% packet loss&#x000A;&#x000A;$ arp -an | grep 72.20.216.78&#x000A;? (72.20.216.78) at 00:09:6b:42:1a:9e on xl1&#x000A;? (72.20.216.62) at (incomplete) on fxp0&#x000A;</pre>
      <h2>Find that Pesky Gateway</h2>
      <p>
        Most ARP requests will come from the gateway on a given subnet. The volume
        of requests make it easy to find the gateway.
      </p>
      <pre>&#x000A;$ sudo tcpdump -n arp&#x000A;tcpdump: listening on rl0, link-type EN10MB&#x000A;20:20:13.080158 arp who-has 192.168.168.199 tell 192.168.168.36&#x000A;20:20:18.584708 arp who-has 192.168.168.191 tell 192.168.168.36&#x000A;20:20:24.931355 arp who-has 72.20.216.61 tell 72.20.216.57&#x000A;20:20:25.955077 arp who-has 192.168.168.199 tell 192.168.168.36&#x000A;20:20:31.955179 arp who-has 192.168.168.199 tell 192.168.168.36&#x000A;</pre>
      <h2>Log Traffic Between two Devices</h2>
      <p>
        If you can't get a hub in-between two points or a switch that support port
        mirroring a second NIC in a laptop can be set up as a bridge between two points
        so that full network trace can be captured. In my T30 <em>fxp0</em> is a
        built-in network card, and <em>dc0</em> is a Xircom combo in my PCCard
        slot.
      </p>
      <pre>&#x000A;ifconfig fxp0 up&#x000A;ifconfig dc0 up&#x000A;ifconfig bridge0 up&#x000A;brconfig bridge0 add fxp0&#x000A;brconfig bridge0 add dc0&#x000A;</pre>
      <pre>&#x000A;$ sudo brconfig&#x000A;bridge0: flags=41&lt;UP,RUNNING&gt;&#x000A;        priority 32768 hellotime 2 fwddelay 15 maxage 20 holdcnt 6 proto rstp&#x000A;        dc0 flags=3&lt;LEARNING,DISCOVER&gt;&#x000A;                port 5 ifpriority 0 ifcost 0&#x000A;        fxp0 flags=3&lt;LEARNING,DISCOVER&gt;&#x000A;                port 2 ifpriority 0 ifcost 0&#x000A;        Addresses (max cache: 100, timeout: 240):&#x000A;</pre>
      <p>
        Now I can log everything with <em>snort</em>
      </p>
      <pre>&#x000A;$ sudo snort -l ./&#x000A;</pre>
      <p>
        or <em>tcpdump</em>:
      </p>
      <pre>&#x000A;$ sudo tcpdump -w file -i ath0&#x000A;tcpdump: listening on ath0, link-type EN10MB&#x000A;^C&#x000A;1557 packets received by filter&#x000A;0 packets dropped by kernel&#x000A;&#x000A;$ sudo tcpdump -r file icmp&#x000A;...&#x000A;</pre>
      <p>
        With a capture on file comparisons are possible between different samples in
        time and maybe even match up a flow with a specific event that you learn of
        from others there.
      </p>
      <h2>Double-Check Subnet Masks</h2>
      <p>
        Even after setting up networks for a while it's not hard to make a mistake
        in calculating subnets, so an IP calculator is a handy way to check yourself.
        It can be installed from ports under <em>net/ipcalc</em>
      </p>
      <pre>&#x000A;$ ipcalc 72.20.214.14/28&#x000A;address   : 72.20.214.14&#x000A;netmask   : 255.255.255.240 (0xfffffff0)&#x000A;network   : 72.20.214.0     /28&#x000A;broadcast : 72.20.214.15&#x000A;host min  : 72.20.214.1&#x000A;host max  : 72.20.214.14&#x000A;hosts/net : 14&#x000A;</pre>
      <h2>
        Check File Integrity
      </h2>
      <p>
        A router can corrupt a data stream. This is rare, but when transferring
        files I've demonstrated that a Cisco 3640 can corrupt the payload of TCP
        packets. Armed with <em>md5</em> you may catch some tricky glitches in hardware
        or software.
      </p>
      <pre>&#x000A;$ md5 test.zip&#x000A;MD5 (test.zip) = 0f155c2bd57bbba564c899da50504ce5&#x000A;</pre>
      <pre>&#x000A;$ ftp <a href="http://teisprint.net/test.zip">http://teisprint.net/test.zip</a>&#x000A;Trying 72.28.48.198...&#x000A;Requesting <a href="http://teisprint.net/test.zip">http://teisprint.net/test.zip</a> (via <a href="http://proxy.eradman.com:8123/)">http://proxy.eradman.com:8123/)</a>&#x000A;100% |**************************************************|  3090 KB    00:20&#x000A;Successfully retrieved file.&#x000A;&#x000A;$ md5 test.zip&#x000A;MD5 (test.zip) = 0f155c2bd57bbba564c899da50504ce5&#x000A;</pre>
      <p>
        Simply comparing file sizes is not a good method of testing the validity of
        a trasmission.
      </p>
      <h2>Routing Loops</h2>
      <p>
        Finding routing loops is not an advanced topic and does not require a
        specialized set of tools. Thanks to <em>tcpdump</em> you can check for this
        anywhere by watching the <em>ttl</em> values. Here we have a switching loop
        (duplicate packets) and a routing loop (TTL moving to 0) on the same LAN.
      </p>
      <pre>&#x000A;$ sudo tcpdump -i fxp0 port 445&#x000A;14:02:25.944847 IP (tos 0x0, ttl   8, id 15937, offset 0, flags [DF], =&#x000A;proto: TCP (6), length: 79) 31.6.2.20.2688 &gt; 31.6.1.2.microsoft-ds: P, =&#x000A;cksum 0xd6dd (correct), 0:39(39) ack 1 win 16529&#x000A;14:02:25.944861 IP (tos 0x0, ttl   7, id 15937, offset 0, flags [DF], =&#x000A;proto: TCP (6), length: 79) 31.6.2.20.2688 &gt; 31.6.1.2.microsoft-ds: P, =&#x000A;cksum 0xd6dd (correct), 0:39(39) ack 1 win 16529&#x000A;14:02:25.944985 IP (tos 0x0, ttl   8, id 15937, offset 0, flags [DF], =&#x000A;proto: TCP (6), length: 79) 31.6.2.20.2688 &gt; 31.6.1.2.microsoft-ds: P, =&#x000A;cksum 0xd6dd (correct), 0:39(39) ack 1 win 16529&#x000A;</pre>
      <p>
        Many times this can be caused by servers with IP forwarding enabled. Test
        a suspect by trying to route packets through the suspect.
      </p>
      <pre>&#x000A;$ sudo route delete default&#x000A;$ sudo route add default 31.6.1.2&#x000A;$ ping eradman.com&#x000A;...&#x000A;</pre>
      <h2>TFTP is Standard</h2>
      <p>
        It's good to be in the habit of copying off configuration of rotuers and
        switches before you modify them, and so that you have a backup.
      </p>
      <pre>&#x000A;# /etc/inetd.conf&#x000A;tftp dgram udp  wait root /usr/libexec/tftpd  tftpd -s /tftpboot&#x000A;tftp dgram udp6 wait root /usr/libexec/tftpd  tftpd -s /tftpboot&#x000A;</pre>
      <p>
        I link the TFTP folder <em>/tftpboot</em> to my home directory. The
        important thing is that <em>inetd</em> have write permission to the file you
        want to copy to.
      </p>
      <pre>&#x000A;$ ls -l /tftpboot&#x000A;lrwxr-xr-x  1 root  wheel  18 Dec 14 03:19 /tftpboot -&gt; /home/eradman/tftp&#x000A;$ touch ~/tftp/PIX515-GATEWAY&#x000A;$ chmod 666 ~/tftp/PIX515-GATEWAY&#x000A;</pre>
      <h2>Log Everything in tmux(1)</h2>
      <p>
        <em>tmux</em> doesn't provide a built-in shortcut for logging the output
        of a session, but it can be easily toggled by adding shortcuts to
        <em>.tmux.conf</em>
      </p>
      <pre>&#x000A;bind-key H pipe-pane &amp;quot;exec cat &gt;&gt;$HOME/'#W-tmux.log'&amp;quot; \;&#x000A;    display-message 'Started logging to $HOME/#W-tmux.log'&#x000A;bind-key h pipe-pane \;&#x000A;    display-message 'Ended logging to $HOME/#W-tmux.log'&#x000A;</pre>
      <h2>Domain Internet Groper</h2>
      <p>
        <em>nslookup</em> is a pain. <em>host</em> gives you what you want to know
        now.
      </p>
      <pre>&#x000A;$ host eradman.com&#x000A;eradman.com has address 72.20.216.13&#x000A;eradman.com has IPv6 address 2001:470:1f00:297:a00:20ff:fe9e:b3e1&#x000A;eradman.com mail is handled by 10 us270-ob0.eradman.com.&#x000A;</pre>
      <p>
        The all-time greatest name award goes to <em>dig</em>, and it also shows you exactally what you want to see:
      </p>
      <pre>&#x000A;$ dig @72.20.216.8 nycbug.org ns +short&#x000A;auth20.ns.nyi.net.&#x000A;auth21.ns.nyi.net.&#x000A;</pre>
      <p>
        In addition to <em>ns</em> (name server) there's also <em>mx</em> (mail
        exchange), <em>aaaa</em> (IPv6 A record), and <em>txt</em> (SPF records).
      </p>
      <p>
        Use <em>-x</em> to look up reverse lookups.
      </p>
      <h2>Wireshark</h2>
      <p>
        It does compile on OpenBSD, and doesn't have to be run as root to read files.
      </p>
      <h2>Find Manufacturer of Device</h2>
      <p>
        First get <a href="http://standards-oui.ieee.org/oui/oui.txt">the IEEE
        MAC assignment list</a>. The first six octets are the manufacturer of a
        particular NIC, so if you know the address of the offending device you may be
        able to tell what kind of device it's in.
      </p>
      <pre>&#x000A;$ arp -an | sed 's/:/-/g'&#x000A;? (192.168.1.1) at 00-01-03-e9-c2-b2 on xl2 static&#x000A;&#x000A;$ grep -i 00-01-03 ~/documents/oui.txt&#x000A;00-01-03   (hex)                3COM CORPORATION&#x000A;</pre>
      <p>
        <em>nmap</em> does this automatically.
      </p>
      <h2>
        Searching for Wireless Networks
      </h2>
      <p>
        OpenBSD's <em>ifconfig(8)</em> completely unifies configuration of various
        network cards, including wireless adaptors. To scan the SSIDs visible to your
        laptop use the <em>scan</em> parameter
      </p>
      <pre>&#x000A;$ sudo ifconfig wpi0 scan&#x000A;wpi0: flags=8843&lt;UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST&gt; mtu 1500&#x000A;        lladdr 00:1b:77:11:10:c5&#x000A;        priority: 4&#x000A;        groups: wlan egress&#x000A;        media: IEEE802.11 autoselect (OFDM54 mode 11g)&#x000A;        status: active&#x000A;        ieee80211: nwid 0024A5B3D55F chan 1 bssid 00:24:a5:b3:d5:5f 63dB ...&#x000A;                nwid 0x00 chan 11 bssid 00:1d:a2:84:cd:30 62dB 54M ...&#x000A;                nwid guest chan 11 bssid 00:1d:a2:84:cd:31 50dB 54M ...&#x000A;                nwid avctrl chan 11 bssid 00:1d:a2:84:cd:32 53dB 54M ...&#x000A;        inet 149.77.212.173 netmask 0xfffffff0 broadcast 149.77.212.175&#x000A;</pre>
      <h2>Link Stability</h2>
      <p>
        Using a network monitor to graph a flood ping can tell  you a lot about link
        stability.
      </p>
      <pre>&#x000A;$ sudo  ping -s 2048 -f 192.168.0.1&#x000A;PING 192.168.0.1 (192.168.0.1): 2048 data bytes&#x000A;/--- 192.168.0.1 ping statistics ---&#x000A;1570 packets transmitted, 1569 packets received, 0.1% packet loss&#x000A;round-trip min/avg/max/std-dev = 6.053/6.850/23.333/0.647 ms&#x000A;</pre>
      <p>
        This graph is from <a href="http://www.gkrellm.net/">gkrellm</a>, and it's
        very useful.
      </p>
      <p class='center'>
        <img src="../library/networking-included/flood-ping.png" alt="gkrellm graph" />
      </p>
      <h2>RS-232 aka Serial Devices</h2>
      <p>
        Serial access is also built-in:
      </p>
      <pre>&#x000A;$ cu -speed 19200 tty00&#x000A;</pre>
      <p>
        <em>BREAK</em> is <em>~#</em> or <em>^A F</em> in <em>minicom</em>. If you
        have USB-to-serial converter you can access it like so
      </p>
      <pre>&#x000A;$ dmesg&#x000A;...&#x000A;ugen1 at uhub6 port 3 configuration 1 &amp;quot;Research In Motion RIM Composite Device&amp;quot; rev 2.00/2.32 addr 8&#x000A;uplcom0 at uhub3 port 1 &amp;quot;Prolific Technology Inc. USB-Serial Controller D&amp;quot; rev 1.10/4.00 addr 2&#x000A;ucom0 at uplcom0&#x000A;</pre>
      <pre>&#x000A;$ sudo cu -l ttyU0&#x000A;&#x000A;</pre>
      <h2>Print Configuration</h2>
      <p>
        12-point courier wastes a lot of paper. Install <em>a2ps</em> from ports and
        use half as much.
      </p>
      <pre>&#x000A;$ a2ps -2 ap.conf -M A5 -o ap.conf.ps&#x000A;</pre>
      <p class='center'>
        <img src="../library/networking-included/ap.conf.png" width="738" height="515" alt="Sample page with two columns" />
      </p>
      <h2>BSD Telnet Works</h2>
      <p>
        It may be a well-kept secret that the BSD telnet can do send one character
        at a time, which is sometimes required to simulate a serial link on some
        terminals need for password prompts, etc.
      </p>
      <pre>&#x000A;$ telnet 22.50.52.90 10001&#x000A;Trying 12.50.52.92...&#x000A;Connected to 12.50.52.92.&#x000A;Escape character is '^]'.&#x000A;&#x000A;ENTER PASSWORD  ^]&#x000A;telnet&gt;; mode character&#x000A;</pre>
      <p>
        Better yet, add common connection parameters to <em>.telnetrc</em>.
      </p>
      <pre>&#x000A;192.168.168.2 # The Simplicity VM&#x000A;  mode character&#x000A;  # do-nothing to make the above line work:&#x000A;  set crmod off&#x000A;</pre>
      <h2>
        XTerm as an ANSI Terminal with VGA Fonts
      </h2>
      <pre>&#x000A;$ cd /usr/X11R6/lib/X11/fonts/misc&#x000A;$ sudo ftp <a href="http://scie.nti.st/dist/sabvga.pcf">http://scie.nti.st/dist/sabvga.pcf</a>&#x000A;$ sudo ftp <a href="http://scie.nti.st/dist/vga.pcf">http://scie.nti.st/dist/vga.pcf</a>&#x000A;$ sudo ftp <a href="http://scie.nti.st/dist/vga11x19.pcf">http://scie.nti.st/dist/vga11x19.pcf</a>&#x000A;$ sudo mkfontdir&#x000A;</pre>
      <p>
        (Thanks to <a
        href="http://scie.nti.st/2007/8/14/dos-ansi-fonts-in-xterm">Garry Dolley</a>
        for posting these fonts and for showing how to do this on OS X as well)
      </p>
      <pre>&#x000A;xterm +sb -fn vga -bg darkblue -fg white&#x000A;</pre>
      <p>
        This is a view to the text console of an HP iLO:
      </p>
      <p class='center'>
        <img src="../library/networking-included/dl360_textcons.png" width="644" height="388" alt="HP iLO using VGA fonts" />
      </p>
      <h2>Custom Key-Mappings</h2>
      <p>
        Proprietary applications often expect goofy character combinations for
        normal use. The key translations in XTerm are very flexible because you can map
        a key pair to any string of characters. I used VIM to figure out key by moving
        the cursor to a character or code (like <em>^M</em>) and typing <em>ga</em> to
        show the hex code in the status line. This is part of my <em>.Xdefaults</em>:
      </p>
      <pre>&#x000A;<span class="Type">XTerm</span><span class="Normal">*</span><span class="Type">VT100</span><span class="Normal">.</span><span class="Type">translations</span><span class="Normal">:</span><span class="Constant"> </span><span class="Statement">#override</span><span class="Constant"> \n </span><span class="Special">\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F1</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x40) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F2</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x41) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F3</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x42) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F4</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x43) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F5</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x44) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F6</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x45) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F7</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x46) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F8</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x47) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F9</span><span class="Normal">:</span><span class="Constant">        string(0x1) string(0x48) string(0xd) </span><span class="Special">\n\</span>&#x000A;<span class="Type"> ~Shift &lt;Key&gt;F10</span><span class="Normal">:</span><span class="Constant">       string(0x1) string(0x49) string(0xd) </span><span class="Special">\n\</span>&#x000A;</pre>
      <p>
        These keys enabled me to manage an old Tadiran voicemail via a network serial
        port:
      </p>
      <p class='center'>
        <img src="../library/networking-included/vgafont.png"
        width="642" height="387" alt="DOS-based voicemail using VGA fonts" />
      </p>
    </div>
    <p class='timestamp'>
      Last updated on March 08, 2017
      <br>
      <a href='https://bitbucket.org/eradman/eradman.com'>eradman.com/source</a>
    </p>
  </body>
</html>
